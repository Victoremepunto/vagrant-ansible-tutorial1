---

# file: /roles/jenkins/tasks/main.yml

- name: add apt key for jenkins
  apt_key: url="{{jenkins.apt_key}}" state=present
  tags: jenkins

- name: add apt repository for jenkins
  apt_repository: repo="{{jenkins.repo}}" state=present
  tags: jenkins

- name: install jenkins
  apt: name=jenkins update_cache=yes
  tags: jenkins

- name: create plugins directory
  file: path="{{jenkins.base_dir}}/plugins" state=directory owner=jenkins group=jenkins
  tags: jenkins

- name: copy jenkins properties
  copy: src={{item}} dest="/etc/default/jenkins"
  with_items:
      - jenkins
  tags: jenkins

- name: ensure plugins are present
  get_url: url="{{jenkins.plugins_url}}/{{item}}.hpi" dest="{{jenkins.base_dir}}/plugins/{{item}}.jpi" owner=jenkins group=jenkins
  with_items:
    - sonar
    - github-oauth
    - credentials
    - git-client
    - scm-api
    - git
    - github-api
    - github
  notify: restart jenkins
  tags: jenkins